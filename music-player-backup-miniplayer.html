<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TuneHub éŸ³ä¹æ’­æ”¾å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            min-height: 100vh;
            color: #333;
            transition: all 0.3s ease;
        }

        /* Light mode (default) */
        body.light-mode {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ed 100%);
        }

        /* Dark mode */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1e 100%);
            color: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .theme-toggle, .mini-player-toggle {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .theme-toggle:hover, .mini-player-toggle:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.1);
        }

        body.dark-mode .theme-toggle, body.dark-mode .mini-player-toggle {
            background: rgba(30, 30, 45, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .play-modes {
            margin: 15px 0;
        }

        .play-modes select {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
        }

        body.dark-mode .play-modes select {
            background: rgba(30, 30, 45, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e0e0e0;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 0.9rem;
            color: #888;
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }

        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }

        /* è¿·ä½ æ’­æ”¾å™¨æ ·å¼ */
        .mini-player {
            position: fixed !important;
            bottom: 20px;
            right: 20px;
            width: 320px !important;
            max-height: 120px !important;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .mini-player-content {
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .mini-player-cover {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .mini-player-info {
            flex: 1;
            min-width: 0;
        }

        .mini-player-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .mini-player-artist {
            font-size: 12px;
            color: #888;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .mini-player-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }

        .mini-player-buttons {
            display: flex;
            gap: 8px;
        }

        .mini-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .mini-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .mini-player-progress {
            width: 100%;
            height: 3px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .mini-player-progress-bar {
            height: 100%;
            background: #667eea;
            width: 0;
            transition: width 0.1s;
        }

        body.dark-mode .mini-player-progress {
            background: rgba(255, 255, 255, 0.1);
        }

        /* éŸ³é¢‘é¢‘è°±å¯è§†åŒ– */
        .visualizer-container {
            width: 100%;
            height: 100px;
            position: absolute;
            bottom: 0;
            left: 0;
            opacity: 0.3;
            pointer-events: none;
        }

        .visualizer {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            height: 100%;
            gap: 2px;
        }

        .visualizer-bar {
            width: 3px;
            background: linear-gradient(to top, #667eea, #764ba2);
            transition: height 0.1s;
            border-radius: 2px 2px 0 0;
        }

        /* æ­Œå•ç®¡ç† */
        .playlist-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        body.dark-mode .playlist-section {
            background: rgba(30, 30, 45, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .playlist-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .playlist-controls input {
            flex: 1;
            padding: 10px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 14px;
        }

        body.dark-mode .playlist-controls input {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .playlist-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .playlist-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .playlist-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .playlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .playlist-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .playlist-item.playing {
            background: rgba(102, 126, 234, 0.2);
        }

        .playlist-name {
            font-weight: 600;
        }

        .playlist-count {
            font-size: 12px;
            color: #888;
        }

        /* é€šçŸ¥æ ·å¼ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1001;
        }

        body.dark-mode .notification {
            background: rgba(30, 30, 45, 0.9);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-icon {
            font-size: 20px;
        }

        .notification-message {
            font-size: 14px;
            font-weight: 500;
        }

        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        body.dark-mode .stats-section {
            background: rgba(30, 30, 45, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 10px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        /* æ¨èæ­Œæ›² */
        .recommendations-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        body.dark-mode .recommendations-section {
            background: rgba(30, 30, 45, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .recommendations-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .recommendation-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .recommendation-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .recommendation-cover {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .recommendation-info {
            flex: 1;
        }

        .recommendation-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .recommendation-artist {
            font-size: 12px;
            color: #888;
        }

        /* æ•°æ®ç®¡ç† */
        .data-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .data-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-export {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-import {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-backup {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .btn-clear {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .data-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* æœç´¢åŒºåŸŸ */
        .search-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            padding-bottom: 10px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        body.dark-mode .search-panel {
            background: rgba(30, 30, 45, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .search-panel > * {
            flex-shrink: 0;
        }

        .search-panel > .song-list {
            flex: 1;
            overflow: hidden;
        }

        .search-panel h2 {
            font-size: 1.1rem;
            margin-bottom: 20px;
            color: #333;
            font-weight: 600;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-box input {
            flex: 1;
            padding: 14px 20px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            font-size: 15px;
            color: #333;
            transition: all 0.3s;
        }

        body.dark-mode .search-box input {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            background: #fff;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.15);
        }

        .search-box input::placeholder {
            color: #999;
        }

        .search-box select {
            padding: 0 16px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-box select:hover {
            background: #fff;
        }

        .search-box select:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-box select option {
            background: #fff;
            color: #333;
        }

        .search-btn {
            padding: 0 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .search-btn:active {
            transform: translateY(0);
        }

        /* æ­Œæ›²åˆ—è¡¨ */
        .song-list {
            max-height: 450px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .song-list::-webkit-scrollbar {
            width: 6px;
        }

        .song-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }

        .song-list::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .song-list::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .song-item {
            display: flex;
            align-items: center;
            padding: 12px 14px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid transparent;
            position: relative;
        }

        .song-item:hover {
            background: #fff;
            border-color: rgba(102, 126, 234, 0.2);
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .song-item.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-color: #667eea;
        }

        .song-item img {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            margin-right: 14px;
            object-fit: cover;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .song-info {
            flex: 1;
            min-width: 0;
        }

        .song-name {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #333;
        }

        .song-item.active .song-name {
            color: #667eea;
        }

        .song-artist {
            font-size: 13px;
            color: #888;
        }

        /* æ’­æ”¾å™¨é¢æ¿ */
        .player-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        body.dark-mode .player-panel {
            background: rgba(30, 30, 45, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .now-playing-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .album-cover-container {
            position: relative;
            margin-bottom: 25px;
        }

        .album-cover {
            width: 280px;
            height: 280px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            transition: all 0.5s;
        }

        .album-cover:hover {
            transform: scale(1.02);
        }

        .album-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .album-cover .placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* æ­£åœ¨æ’­æ”¾åŠ¨ç”» */
        .album-cover.playing {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 20px 50px rgba(102, 126, 234, 0.3); }
            50% { box-shadow: 0 20px 60px rgba(102, 126, 234, 0.5); }
        }

        .song-details {
            text-align: center;
            margin-bottom: 25px;
        }

        .song-details h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: #333;
        }

        .song-details p {
            color: #888;
            font-size: 14px;
            margin-bottom: 4px;
        }

        /* è¿›åº¦æ¡ */
        .progress-section {
            width: 100%;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            transition: height 0.2s;
        }

        .progress-bar:hover {
            height: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: #667eea;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .progress-bar:hover .progress-fill::after {
            opacity: 1;
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            color: #888;
            font-weight: 500;
        }

        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 24px;
            margin-bottom: 25px;
        }

        .control-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: rgba(0, 0, 0, 0.05);
            color: #333;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.1);
        }

        .play-btn {
            width: 64px;
            height: 64px;
            font-size: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .play-btn:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transform: scale(1.05);
        }

        /* éŸ³è´¨é€‰æ‹© */
        .quality-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 25px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 12px;
        }

        .quality-label {
            font-size: 13px;
            color: #888;
        }

        .quality-select {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 13px;
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quality-select:hover {
            background: #fff;
        }

        .quality-select option {
            background: #fff;
            color: #333;
        }

        .quality-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 6px;
            font-size: 11px;
            color: #667eea;
            font-weight: 500;
            animation: pulse-status 1.5s ease-in-out infinite;
        }

        @keyframes pulse-status {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* éŸ³é‡æ§åˆ¶ */
        .volume-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 25px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 12px;
        }

        .volume-label {
            font-size: 13px;
            color: #888;
        }

        .volume-slider {
            width: 150px;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }

        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 3px 8px rgba(102, 126, 234, 0.4);
        }

        .volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }

        .volume-slider::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 3px 8px rgba(102, 126, 234, 0.4);
        }

        .volume-value {
            font-size: 13px;
            color: #888;
            min-width: 40px;
            text-align: right;
        }

        /* ä¸‹è½½æŒ‰é’® */
        .download-section {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 25px;
        }

        .download-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #fff;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .download-btn:active {
            transform: translateY(0);
        }

        .btn-download-all {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-download-audio {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .btn-download-lyrics {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .btn-download-cover {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        /* æ­Œè¯åŒºåŸŸ */
        .lyrics-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .lyrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }

        .lyrics-header h3 {
            font-size: 1.1rem;
            color: #333;
            font-weight: 600;
        }

        .lyrics-content {
            max-height: 400px;
            overflow-y: auto;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 2;
            color: #666;
            padding: 10px;
        }

        .lyrics-content::-webkit-scrollbar {
            width: 4px;
        }

        .lyrics-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }

        .lyrics-content::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 2px;
        }

        .lyrics-line {
            padding: 8px 0;
            transition: all 0.3s;
            border-radius: 8px;
            font-size: 14px;
        }

        .lyrics-line:hover {
            color: #999;
            background: rgba(102, 126, 234, 0.05);
        }

        .lyrics-line.active {
            color: #667eea;
            font-size: 16px;
            font-weight: 600;
            background: rgba(102, 126, 234, 0.1);
        }

        /* çŠ¶æ€æç¤º */
        .loading {
            text-align: center;
            padding: 30px;
            color: #888;
        }

        .loading::before {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .song-list-title {
            font-size: 1rem;
            color: #888;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.6rem;
            }

            .search-box {
                flex-wrap: wrap;
            }

            .search-box input,
            .search-box select,
            .search-btn {
                width: 100%;
            }

            .album-cover {
                width: 220px;
                height: 220px;
            }

            .controls {
                gap: 16px;
            }

            .control-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .play-btn {
                width: 56px;
                height: 56px;
                font-size: 20px;
            }

            .download-section {
                flex-direction: column;
            }

            .download-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-controls">
                <h1>TuneHub éŸ³ä¹æ’­æ”¾å™¨</h1>
                <div class="header-buttons">
                    <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()">
                        <span id="themeIcon">ğŸŒ™</span>
                    </button>
                    <button id="miniPlayerToggle" class="mini-player-toggle" onclick="toggleMiniPlayer()">
                        <span>â¬‡ï¸</span>
                    </button>
                </div>
            </div>
            <p>æœç´¢ Â· æ’­æ”¾ Â· ä¸‹è½½</p>
            <div class="play-modes">
                <select id="playModeSelect" onchange="changePlayMode()">
                    <option value="normal">é¡ºåºæ’­æ”¾</option>
                    <option value="single">å•æ›²å¾ªç¯</option>
                    <option value="loop">åˆ—è¡¨å¾ªç¯</option>
                    <option value="shuffle">éšæœºæ’­æ”¾</option>
                </select>
            </div>
        </div>

        <div class="main-container">
            <!-- å·¦ä¾§ï¼šæœç´¢å’Œåˆ—è¡¨ -->
            <div class="left-panel">
                <div class="search-panel">
                    <h2>æœç´¢éŸ³ä¹</h2>
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="è¾“å…¥æ­Œæ›²åç§°æˆ–æ­Œæ‰‹...">
                        <select id="platformSelect">
                            <option value="netease">ç½‘æ˜“äº‘éŸ³ä¹</option>
                            <option value="kuwo">é…·æˆ‘éŸ³ä¹</option>
                            <option value="qq">QQéŸ³ä¹</option>
                            <option value="aggregateSearch">èšåˆæœç´¢</option>
                        </select>
                        <select id="qualitySelect">
                            <option value="320k">é«˜å“è´¨ 320k</option>
                            <option value="128k">æ ‡å‡† 128k</option>
                            <option value="flac">æ— æŸ FLAC</option>
                            <option value="flac24bit">Hi-Res FLAC 24bit</option>
                        </select>
                        <button class="search-btn" onclick="searchMusic()">æœç´¢</button>
                    </div>
                    <div id="songList" class="song-list">
                        <div class="song-list-title">è¯·æœç´¢æ‚¨æƒ³å¬çš„æ­Œæ›²</div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæ’­æ”¾å™¨å’Œæ­Œè¯ -->
            <div class="right-panel">
                <!-- å¯è§†åŒ–å®¹å™¨ -->
                <div class="visualizer-container">
                    <canvas class="visualizer" id="visualizer"></canvas>
                </div>

                <!-- è¿·ä½ æ’­æ”¾å™¨ï¼ˆé»˜è®¤éšè—ï¼‰ -->
                <div class="mini-player" id="miniPlayer" style="display: none;">
                    <div class="mini-player-content">
                        <div class="mini-player-cover" id="miniPlayerCover">
                            <div class="placeholder">ğŸµ</div>
                        </div>
                        <div class="mini-player-info">
                            <div class="mini-player-title" id="miniPlayerTitle">æœªæ’­æ”¾</div>
                            <div class="mini-player-artist" id="miniPlayerArtist">-</div>
                        </div>
                        <div class="mini-player-controls">
                            <div class="mini-player-buttons">
                                <button class="mini-btn" onclick="previousSong()">â®</button>
                                <button class="mini-btn play-btn" onclick="togglePlay()" id="miniPlayBtn">â–¶</button>
                                <button class="mini-btn" onclick="nextSong()">â­</button>
                            </div>
                            <div class="mini-player-progress">
                                <div class="mini-player-progress-bar" id="miniProgressBar"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="player-panel" id="playerPanel">
                    <div class="now-playing-section">
                        <div class="album-cover-container">
                            <div class="album-cover" id="albumCover">
                                <div class="placeholder">ğŸµ</div>
                            </div>
                        </div>
                        <div class="song-details">
                            <h2 id="currentSongName">æœªæ’­æ”¾</h2>
                            <p id="currentArtist">-</p>
                            <p id="currentAlbum">-</p>
                        </div>
                        <div class="progress-section">
                            <div class="progress-bar" onclick="seekTo(event)">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="time-info">
                                <span id="currentTime">0:00</span>
                                <span id="duration">0:00</span>
                            </div>
                        </div>
                        <div class="controls">
                            <button class="control-btn" onclick="previousSong()">â®</button>
                            <button class="control-btn play-btn" onclick="togglePlay()" id="playBtn">â–¶</button>
                            <button class="control-btn" onclick="nextSong()">â­</button>
                        </div>
                        <div class="quality-section">
                            <span class="quality-label" id="currentQuality">å½“å‰éŸ³è´¨: é«˜å“è´¨ 320k</span>
                            <select id="qualityChange" class="quality-select" onchange="changeQuality()">
                                <option value="320k">é«˜å“è´¨ 320k</option>
                                <option value="128k">æ ‡å‡† 128k</option>
                                <option value="flac">æ— æŸ FLAC</option>
                                <option value="flac24bit">Hi-Res FLAC 24bit</option>
                            </select>
                            <span id="qualityStatus" class="quality-status" style="display: none;">âš¡ åˆ‡æ¢ä¸­</span>
                        </div>
                        <div class="volume-section">
                            <span class="volume-label">éŸ³é‡</span>
                            <input type="range" id="volumeSlider" min="0" max="100" value="80" class="volume-slider" onchange="changeVolume()">
                            <span id="volumeValue" class="volume-value">80%</span>
                        </div>
                        <div class="playlist-add-section" style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 25px; padding: 12px; background: rgba(0, 0, 0, 0.03); border-radius: 12px;">
                            <span class="playlist-label" style="font-size: 13px; color: #888;">æ­Œå•æ“ä½œ</span>
                            <button class="playlist-add-btn" onclick="addCurrentSongToPlaylist()" style="padding: 10px 20px; border: none; border-radius: 8px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; cursor: pointer; font-size: 13px; transition: all 0.3s; display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 16px;">ğŸ“</span> æ·»åŠ åˆ°æ­Œå•
                            </button>
                        </div>
                        <div class="download-section">
                            <button class="download-btn btn-download-all" onclick="downloadAll()">
                                <span>ğŸ“¦</span> ä¸‹è½½å…¨éƒ¨
                            </button>
                            <button class="download-btn btn-download-audio" onclick="downloadAudioAndLyrics()">
                                <span>ğŸµğŸ“</span> æ­Œæ›²+æ­Œè¯
                            </button>
                            <button class="download-btn btn-download-audio" onclick="downloadCurrentQualityAudio()">
                                <span>âš¡</span> ä¸‹è½½å½“å‰éŸ³è´¨
                            </button>
                            <button class="download-btn btn-download-lyrics" onclick="downloadLyrics()">
                                <span>ğŸ“</span> æ­Œè¯
                            </button>
                            <button class="download-btn btn-download-cover" onclick="downloadCover()">
                                <span>ğŸ–¼ï¸</span> å°é¢
                            </button>
                        </div>
                    </div>
                </div>

                <!-- æ­Œè¯é¢æ¿ -->
                <div class="lyrics-panel" style="margin-top: 30px;">
                    <div class="lyrics-header">
                        <h3>æ­Œè¯</h3>
                    </div>
                    <div id="lyricsContent" class="lyrics-content">
                        <div style="text-align: center; color: #666; padding: 40px;">
                            é€‰æ‹©æ­Œæ›²åæ˜¾ç¤ºæ­Œè¯
                        </div>
                    </div>
                </div>

                <!-- æ­Œå•ç®¡ç† -->
                <div class="playlist-section">
                    <h3>ğŸ“ æˆ‘çš„æ­Œå•</h3>
                    <p style="font-size: 12px; color: #888; margin-bottom: 10px;">
                        ğŸ’¡ ä½¿ç”¨æ–¹æ³•ï¼šâ‘  åˆ›å»ºæ­Œå• â†’ â‘¡ ç‚¹å‡»é€‰æ‹© â†’ â‘¢ æ’­æ”¾æ­Œæ›² â†’ â‘£ ç‚¹å‡»æ’­æ”¾å™¨ä¸Šçš„ã€ŒğŸ“ æ·»åŠ åˆ°æ­Œå•ã€æŒ‰é’®
                    </p>
                    <div class="playlist-controls">
                        <input type="text" id="playlistNameInput" placeholder="è¾“å…¥æ­Œå•åç§°...">
                        <button class="playlist-btn" onclick="createPlaylist()">åˆ›å»ºæ­Œå•</button>
                    </div>
                    <div id="playlistList" class="playlist-list">
                        <!-- æ­Œå•åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div id="currentPlaylistStatus" style="margin-top: 10px; font-size: 12px; color: #667eea;">
                        ğŸ“Œ å½“å‰æœªé€‰æ‹©æ­Œå•ï¼ˆç‚¹å‡»ä¸‹æ–¹æ­Œå•è¿›è¡Œé€‰æ‹©ï¼‰
                    </div>
                </div>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="stats-section">
                    <h3>æ’­æ”¾ç»Ÿè®¡</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="totalPlayCount">0</div>
                            <div class="stat-label">æ€»æ’­æ”¾æ¬¡æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="todayPlayCount">0</div>
                            <div class="stat-label">ä»Šæ—¥æ’­æ”¾</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalPlayTime">0</div>
                            <div class="stat-label">æ€»æ—¶é•¿ï¼ˆåˆ†ï¼‰</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="favoriteCount">0</div>
                            <div class="stat-label">æœ€çˆ±æ­Œæ›²</div>
                        </div>
                    </div>
                </div>

                <!-- æ¨èæ­Œæ›² -->
                <div class="recommendations-section">
                    <h3>æ¨èç®—æ³•</h3>
                    <div id="recommendationsList">
                        <div class="recommendation-item" onclick="loadRecommendation(this)">
                            <div class="recommendation-cover">ğŸµ</div>
                            <div class="recommendation-info">
                                <div class="recommendation-name">æ¨èå°†æ ¹æ®æ‚¨çš„æ’­æ”¾å†å²ç”Ÿæˆ</div>
                                <div class="recommendation-artist">æ’­æ”¾æ›´å¤šæ­Œæ›²ä»¥è·å–ä¸ªæ€§åŒ–æ¨è</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ•°æ®ç®¡ç† -->
                <div class="data-controls">
                    <button class="data-btn btn-export" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                    <button class="data-btn btn-import" onclick="document.getElementById('importFile').click()">å¯¼å…¥æ•°æ®</button>
                    <button class="data-btn btn-backup" onclick="backupData()">å¤‡ä»½æ•°æ®</button>
                    <button class="data-btn btn-clear" onclick="clearAllData()">æ¸…ç©ºæ•°æ®</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                </div>
            </div>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®å¸¸é‡
        const API_BASE = 'https://music-dl.sayqz.com';
        const QUALITIES = ['128k', '320k', 'flac', 'flac24bit'];
        const QUALITY_NAMES = {
            '128k': 'æ ‡å‡† 128k',
            '320k': 'é«˜å“è´¨ 320k',
            'flac': 'æ— æŸ FLAC',
            'flac24bit': 'Hi-Res FLAC 24bit'
        };

        // æ’­æ”¾æ¨¡å¼
        const PLAY_MODES = {
            normal: 'é¡ºåºæ’­æ”¾',
            single: 'å•æ›²å¾ªç¯',
            loop: 'åˆ—è¡¨å¾ªç¯',
            shuffle: 'éšæœºæ’­æ”¾'
        };

        // å…¨å±€å˜é‡
        let audioContext;
        let analyser;
        let dataArray;
        let isMiniPlayer = false;
        let currentPlayMode = 'normal';
        let playlists = {};
        let currentPlaylist = null; // å½“å‰é€‰ä¸­çš„æ­Œå•
        let playHistory = [];
        let playStatistics = {};
        let recommendations = [];
        let visualizerBars = 64;
        const PLATFORMS = {
            'netease': 'ç½‘æ˜“äº‘éŸ³ä¹',
            'kuwo': 'é…·æˆ‘éŸ³ä¹',
            'qq': 'QQéŸ³ä¹',
            'aggregateSearch': 'èšåˆæœç´¢'
        };

        // æ’­æ”¾å™¨çŠ¶æ€
        let audio = new Audio();
        let currentSong = null;
        let isPlaying = false;
        let songs = [];
        let currentSongIndex = 0;
        let lyricsData = [];
        let currentSongInfo = null;
        let currentQuality = '320k';
        let audioUrlMap = {};
        let currentPlatform = 'netease';
        let lastLyricsIndex = -1;
        let lyricsUpdateTimer = null;

        // åˆå§‹åŒ–
        window.onload = function() {
            // å…ˆè°ƒç”¨åˆå§‹åŒ–
            initialize();

            audio.addEventListener('timeupdate', updateProgress);
            audio.addEventListener('ended', nextSong);
            audio.addEventListener('loadedmetadata', function() {
                document.getElementById('duration').textContent = formatTime(audio.duration);
            });
            audio.addEventListener('play', () => {
                isPlaying = true;
                updatePlayButton();
                document.getElementById('albumCover')?.classList.add('playing');

                // å¼€å§‹å¯è§†åŒ–
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume();
                }
            });
            audio.addEventListener('pause', () => {
                isPlaying = false;
                updatePlayButton();
                document.getElementById('albumCover')?.classList.remove('playing');
            });

            initQuality();
            initVolume();

            // æœç´¢æ¡†å›è½¦äº‹ä»¶
            document.getElementById('searchInput').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    searchMusic();
                }
            });
        };

        // åˆå§‹åŒ–éŸ³é‡
        function initVolume() {
            const savedVolume = localStorage.getItem('preferredVolume');
            if (savedVolume) {
                audio.volume = savedVolume / 100;
                document.getElementById('volumeSlider').value = savedVolume;
                document.getElementById('volumeValue').textContent = savedVolume + '%';
            } else {
                audio.volume = 0.8;
            }
        }

        // æ”¹å˜éŸ³é‡
        function changeVolume() {
            const volume = document.getElementById('volumeSlider').value;
            audio.volume = volume / 100;
            document.getElementById('volumeValue').textContent = volume + '%';
            localStorage.setItem('preferredVolume', volume);
        }

        // ä¸»é¢˜åˆ‡æ¢
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');

            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                themeIcon.textContent = 'ğŸŒ™';
                localStorage.setItem('theme', 'light');
                showNotification('å·²åˆ‡æ¢åˆ°äº®è‰²æ¨¡å¼', 'âœ¨');
            } else {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
                themeIcon.textContent = 'â˜€ï¸';
                localStorage.setItem('theme', 'dark');
                showNotification('å·²åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼', 'ğŸŒ™');
            }
        }

        // è¿·ä½ æ’­æ”¾å™¨åˆ‡æ¢
        function toggleMiniPlayer() {
            const playerPanel = document.getElementById('playerPanel');
            const miniPlayer = document.getElementById('miniPlayer');
            const container = document.querySelector('.container');
            const miniPlayerToggle = document.getElementById('miniPlayerToggle');

            if (isMiniPlayer) {
                // è¿”å›æ­£å¸¸æ¨¡å¼
                isMiniPlayer = false;
                miniPlayer.style.display = 'none';
                playerPanel.style.display = 'block';
                container.style.display = 'block';
                miniPlayerToggle.innerHTML = '<span>â¬‡ï¸</span>';
                showNotification('å·²è¿”å›æ­£å¸¸æ’­æ”¾å™¨', 'â†©ï¸');
            } else {
                // è¿›å…¥è¿·ä½ æ¨¡å¼
                isMiniPlayer = true;
                miniPlayer.style.display = 'block';
                playerPanel.style.display = 'none';
                container.style.display = 'none';
                miniPlayerToggle.innerHTML = '<span>â¬†ï¸</span>';
                updateMiniPlayer();
                showNotification('å·²åˆ‡æ¢åˆ°è¿·ä½ æ’­æ”¾å™¨', 'â¬‡ï¸');
            }
        }

        // æ›´æ–°è¿·ä½ æ’­æ”¾å™¨æ˜¾ç¤º
        function updateMiniPlayer() {
            if (!isMiniPlayer) return;

            const cover = document.getElementById('miniPlayerCover');
            const title = document.getElementById('miniPlayerTitle');
            const artist = document.getElementById('miniPlayerArtist');
            const progressBar = document.getElementById('miniProgressBar');

            if (cover) {
                if (currentSongInfo?.pic) {
                    cover.innerHTML = `<img src="${currentSongInfo.pic}" alt="Cover" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
                } else {
                    cover.innerHTML = '<div class="placeholder" style="font-size: 24px;">ğŸµ</div>';
                }
            }

            if (title) title.textContent = currentSongInfo?.name || 'æœªæ’­æ”¾';
            if (artist) artist.textContent = currentSongInfo?.artist || '-';

            if (progressBar && audio) {
                const progress = (audio.currentTime / audio.duration) * 100 || 0;
                progressBar.style.width = `${progress}%`;
            }
        }

        // åˆå§‹åŒ–éŸ³é¢‘å¯è§†åŒ–
        function initVisualizer() {
            const canvas = document.getElementById('visualizer');
            if (!canvas) return;

            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;

            const bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);

            // åˆ›å»ºå¯è§†åŒ–æ¡
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            const ctx = canvas.getContext('2d');

            drawVisualizer(ctx, canvas);
        }

        // ç»˜åˆ¶å¯è§†åŒ–æ•ˆæœ
        function drawVisualizer(ctx, canvas) {
            requestAnimationFrame(() => drawVisualizer(ctx, canvas));

            if (!analyser) return;

            analyser.getByteFrequencyData(dataArray);

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const barWidth = (canvas.width / visualizerBars) * 2.5;
            let x = 0;

            for (let i = 0; i < visualizerBars; i++) {
                const barHeight = (dataArray[i] / 255) * canvas.height * 0.8;

                const gradient = ctx.createLinearGradient(0, canvas.height, 0, 0);
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');

                ctx.fillStyle = gradient;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);

                x += barWidth + 1;
            }
        }

        // æ’­æ”¾æ¨¡å¼åˆ‡æ¢
        function changePlayMode() {
            currentPlayMode = document.getElementById('playModeSelect').value;
            showNotification(`æ’­æ”¾æ¨¡å¼: ${PLAY_MODES[currentPlayMode]}`, 'ğŸµ');

            // ä¿å­˜è®¾ç½®
            localStorage.setItem('playMode', currentPlayMode);
        }

        // åˆ›å»ºæ­Œå•
        function createPlaylist() {
            const input = document.getElementById('playlistNameInput');
            const playlistName = input.value.trim();

            if (!playlistName) {
                showNotification('è¯·è¾“å…¥æ­Œå•åç§°', 'âš ï¸');
                return;
            }

            if (playlists[playlistName]) {
                showNotification('æ­Œå•å·²å­˜åœ¨', 'âš ï¸');
                return;
            }

            playlists[playlistName] = {
                name: playlistName,
                songs: [],
                createdAt: new Date().toISOString()
            };

            input.value = '';
            savePlaylists();
            updatePlaylistDisplay();
            showNotification(`æ­Œå• "${playlistName}" åˆ›å»ºæˆåŠŸ`, 'âœ…');
        }

        // é€‰æ‹©æ­Œå•
        function selectPlaylist(name) {
            currentPlaylist = name;
            updatePlaylistDisplay();
            document.getElementById('currentPlaylistStatus').textContent = `å½“å‰æ­Œå•: ${name}`;
            showNotification(`å·²é€‰æ‹©æ­Œå•: ${name}`, 'ğŸµ');
        }

        // æ·»åŠ æ­Œæ›²åˆ°å½“å‰æ­Œå•
        function addSongToPlaylist(song) {
            if (!currentPlaylist) {
                showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ­Œå•', 'âš ï¸');
                return;
            }

            if (!playlists[currentPlaylist]) {
                showNotification('æ­Œå•ä¸å­˜åœ¨', 'âŒ');
                return;
            }

            // æ£€æŸ¥æ­Œæ›²æ˜¯å¦å·²åœ¨æ­Œå•ä¸­
            const exists = playlists[currentPlaylist].songs.some(s => s.id === song.id);
            if (exists) {
                showNotification('æ­Œæ›²å·²åœ¨æ­Œå•ä¸­', 'âš ï¸');
                return;
            }

            // æ·»åŠ æ­Œæ›²åˆ°æ­Œå•
            playlists[currentPlaylist].songs.push({
                ...song,
                addedAt: new Date().toISOString()
            });

            savePlaylists();
            updatePlaylistDisplay();
            showNotification(`å·²æ·»åŠ åˆ°æ­Œå• "${currentPlaylist}"`, 'âœ…');
        }

        // æ·»åŠ å½“å‰æ’­æ”¾çš„æ­Œæ›²åˆ°æ­Œå•ï¼ˆæ–°å¢åŠŸèƒ½ï¼‰
        function addCurrentSongToPlaylist() {
            if (!currentSong) {
                showNotification('è¯·å…ˆæ’­æ”¾ä¸€é¦–æ­Œæ›²', 'âš ï¸');
                return;
            }

            if (!currentPlaylist) {
                showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ­Œå•', 'âš ï¸');
                // æ˜¾ç¤ºæ­Œå•åˆ—è¡¨è®©ç”¨æˆ·é€‰æ‹©
                setTimeout(() => {
                    const playlistList = document.getElementById('playlistList');
                    if (playlistList) {
                        playlistList.scrollIntoView({ behavior: 'smooth' });
                        showNotification('è¯·åœ¨ä¸‹æ–¹é€‰æ‹©ä¸€ä¸ªæ­Œå•', 'ğŸ‘‡');
                    }
                }, 500);
                return;
            }

            if (!playlists[currentPlaylist]) {
                showNotification('æ­Œå•ä¸å­˜åœ¨', 'âŒ');
                return;
            }

            // æ£€æŸ¥æ­Œæ›²æ˜¯å¦å·²åœ¨æ­Œå•ä¸­
            const exists = playlists[currentPlaylist].songs.some(s => s.id === currentSong.id);
            if (exists) {
                showNotification('æ­Œæ›²å·²åœ¨æ­Œå•ä¸­', 'âš ï¸');
                return;
            }

            // æ·»åŠ æ­Œæ›²åˆ°æ­Œå•
            playlists[currentPlaylist].songs.push({
                ...currentSong,
                addedAt: new Date().toISOString()
            });

            savePlaylists();
            updatePlaylistDisplay();
            showNotification(`å·²å°†ã€Š${currentSong.name}ã€‹æ·»åŠ åˆ°æ­Œå• "${currentPlaylist}"`, 'âœ…');
        }

        // ä»æ­Œå•ä¸­ç§»é™¤æ­Œæ›²
        function removeSongFromPlaylist(playlistName, songId) {
            if (!playlists[playlistName]) return;

            playlists[playlistName].songs = playlists[playlistName].songs.filter(
                song => song.id !== songId
            );

            savePlaylists();
            updatePlaylistDisplay();
            showNotification('æ­Œæ›²å·²ä»æ­Œå•ç§»é™¤', 'âœ…');
        }

        // ä»æ­Œå•æ’­æ”¾æ­Œæ›²ï¼ˆæ–°å¢åŠŸèƒ½ï¼‰
        function playFromPlaylist(playlistName, songId) {
            const playlist = playlists[playlistName];
            if (!playlist) return;

            const song = playlist.songs.find(s => s.id === songId);
            if (!song) {
                showNotification('æ­Œæ›²ä¸å­˜åœ¨', 'âŒ');
                return;
            }

            // è®¾ç½®å½“å‰æœç´¢ç»“æœä¸ºæ­Œå•ä¸­çš„æ­Œæ›²ï¼Œä»¥ä¾¿æ’­æ”¾å™¨æ­£å¸¸å·¥ä½œ
            songs = playlist.songs;

            // æ‰¾åˆ°æ­Œæ›²åœ¨æ­Œå•ä¸­çš„ç´¢å¼•
            const index = playlist.songs.findIndex(s => s.id === songId);

            // æ’­æ”¾æ­Œæ›²
            playSong(index);
            showNotification(`æ­£åœ¨æ’­æ”¾: ${song.name}`, 'ğŸµ');
        }

        // ä¿å­˜æ­Œå•
        function savePlaylists() {
            localStorage.setItem('playlists', JSON.stringify(playlists));
        }

        // åŠ è½½æ­Œå•
        function loadPlaylists() {
            const saved = localStorage.getItem('playlists');
            if (saved) {
                playlists = JSON.parse(saved);
            }
            updatePlaylistDisplay();
        }

        // æ›´æ–°æ­Œå•æ˜¾ç¤º
        function updatePlaylistDisplay() {
            const playlistList = document.getElementById('playlistList');
            if (!playlistList) return;

            playlistList.innerHTML = '';

            if (Object.keys(playlists).length === 0) {
                playlistList.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">æš‚æ— æ­Œå•ï¼Œè¯·å…ˆåˆ›å»ºæ­Œå•</div>';
                return;
            }

            Object.keys(playlists).forEach(name => {
                const playlist = playlists[name];
                const item = document.createElement('div');
                const isSelected = currentPlaylist === name;

                item.className = `playlist-item ${isSelected ? 'playing' : ''}`;
                item.onclick = () => selectPlaylist(name);
                item.innerHTML = `
                    <div>
                        <div class="playlist-name">${name}</div>
                        <div class="playlist-count">${playlist.songs.length} é¦–æ­Œæ›²</div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        ${isSelected ? '<span style="color: #667eea;">âœ“</span>' : ''}
                        <button onclick="event.stopPropagation(); deletePlaylist('${name}')" style="background: none; border: none; color: #ef4444; cursor: pointer;">åˆ é™¤</button>
                    </div>
                `;
                playlistList.appendChild(item);

                // å¦‚æœæ­Œå•æœ‰æ­Œæ›²ï¼Œæ˜¾ç¤ºæ­Œæ›²åˆ—è¡¨
                if (playlist.songs.length > 0 && isSelected) {
                    const songList = document.createElement('div');
                    songList.style.marginTop = '10px';
                    songList.style.padding = '10px';
                    songList.style.background = 'rgba(0, 0, 0, 0.03)';
                    songList.style.borderRadius = '8px';

                    playlist.songs.forEach((song, songIndex) => {
                        const songItem = document.createElement('div');
                        songItem.style.cssText = `
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 8px;
                            margin-bottom: 5px;
                            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
                            cursor: pointer;
                            transition: all 0.2s;
                            border-radius: 6px;
                        `;
                        songItem.onmouseenter = function() {
                            this.style.background = 'rgba(102, 126, 234, 0.1)';
                        };
                        songItem.onmouseleave = function() {
                            this.style.background = 'transparent';
                        };
                        songItem.onclick = () => playFromPlaylist(name, song.id);

                        songItem.innerHTML = `
                            <div style="flex: 1; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 18px;">â–¶ï¸</span>
                                <div>
                                    <div style="font-size: 14px; font-weight: 500;">${song.name}</div>
                                    <div style="font-size: 12px; color: #888;">${song.artist || 'æœªçŸ¥æ­Œæ‰‹'}</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button onclick="event.stopPropagation(); removeSongFromPlaylist('${name}', '${song.id}')"
                                    style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 16px; padding: 4px; border-radius: 4px;"
                                    title="ä»æ­Œå•ç§»é™¤">Ã—</button>
                            </div>
                        `;

                        songList.appendChild(songItem);
                    });

                    item.appendChild(songList);
                }
            });
        }

        // åˆ é™¤æ­Œå•
        function deletePlaylist(name) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤æ­Œå• "${name}" å—ï¼Ÿ`)) {
                delete playlists[name];
                if (currentPlaylist === name) {
                    currentPlaylist = null;
                    document.getElementById('currentPlaylistStatus').textContent = 'å½“å‰æœªé€‰æ‹©æ­Œå•';
                }
                savePlaylists();
                updatePlaylistDisplay();
                showNotification('æ­Œå•å·²åˆ é™¤', 'âœ…');
            }
        }

        // æ’­æ”¾ç»Ÿè®¡
        function updatePlayStatistics() {
            if (!currentSong) return;

            const today = new Date().toDateString();

            if (!playStatistics[currentSong.id]) {
                playStatistics[currentSong.id] = {
                    count: 0,
                    totalPlayTime: 0,
                    lastPlayed: null,
                    favoriteCount: 0
                };
            }

            playStatistics[currentSong.id].count++;
            playStatistics[currentSong.id].lastPlayed = new Date().toISOString();

            // æ›´æ–°ä»Šæ—¥æ’­æ”¾æ•°
            if (!playStatistics.today) {
                playStatistics.today = 0;
            }
            playStatistics.today++;

            // ä¿å­˜ç»Ÿè®¡
            localStorage.setItem('playStatistics', JSON.stringify(playStatistics));

            // æ›´æ–°æ˜¾ç¤º
            updateStatsDisplay();
        }

        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateStatsDisplay() {
            const stats = playStatistics;
            let totalCount = 0;
            let totalMinutes = 0;
            let todayCount = stats.today || 0;
            let favoriteCount = 0;

            Object.keys(stats).forEach(id => {
                if (id !== 'today') {
                    const stat = stats[id];
                    totalCount += stat.count;
                    totalMinutes += stat.totalPlayTime / 60;
                    if (stat.favoriteCount > 0) favoriteCount++;
                }
            });

            document.getElementById('totalPlayCount').textContent = totalCount;
            document.getElementById('todayPlayCount').textContent = todayCount;
            document.getElementById('totalPlayTime').textContent = Math.floor(totalMinutes);
            document.getElementById('favoriteCount').textContent = favoriteCount;
        }

        // ç”Ÿæˆæ¨è
        function generateRecommendations() {
            const playedSongs = Object.keys(playStatistics).filter(id => id !== 'today');

            if (playedSongs.length < 3) {
                return [
                    { name: 'çƒ­é—¨æ­Œæ›²', artist: 'ç³»ç»Ÿæ¨è' },
                    { name: 'å‘ç°éŸ³ä¹', artist: 'ä¸ªæ€§åŒ–æ¨è' },
                    { name: 'æ¯æ—¥æ¨è', artist: 'æ ¹æ®å–œå¥½' }
                ];
            }

            // ç®€å•æ¨èç®—æ³•ï¼šåŸºäºæ’­æ”¾é¢‘ç‡
            const recommendations = [];
            playedSongs.sort((a, b) => {
                return playStatistics[b].count - playStatistics[a].count;
            });

            // å–æ’­æ”¾æœ€å¤šçš„3é¦–æ­Œæ›²ä½œä¸ºæ¨èåŸºç¡€
            playedSongs.slice(0, 3).forEach(songId => {
                const song = findSongById(songId);
                if (song) {
                    recommendations.push({
                        name: song.name,
                        artist: song.artist
                    });
                }
            });

            return recommendations.length > 0 ? recommendations :
                [{ name: 'æ¢ç´¢æ–°éŸ³ä¹', artist: 'æ’­æ”¾æ›´å¤šæ­Œæ›²' }];
        }

        // æ ¹æ®IDæŸ¥æ‰¾æ­Œæ›²
        function findSongById(songId) {
            return songs.find(song => song.id === songId);
        }

        // åŠ è½½æ¨èæ­Œæ›²
        function loadRecommendation(element) {
            const name = element.querySelector('.recommendation-name').textContent;
            const artist = element.querySelector('.recommendation-artist').textContent;

            // æœç´¢æ¨èçš„æ­Œæ›²
            document.getElementById('searchInput').value = `${name} ${artist}`;
            searchMusic();

            showNotification('æ­£åœ¨æœç´¢æ¨èæ­Œæ›²...', 'ğŸ”');
        }

        // æ›´æ–°æ¨èæ˜¾ç¤º
        function updateRecommendations() {
            const container = document.getElementById('recommendationsList');
            if (!container) return;

            const recommendations = generateRecommendations();

            container.innerHTML = recommendations.map((rec, index) => `
                <div class="recommendation-item" onclick="loadRecommendation(this)">
                    <div class="recommendation-cover">${index + 1}</div>
                    <div class="recommendation-info">
                        <div class="recommendation-name">${rec.name}</div>
                        <div class="recommendation-artist">${rec.artist}</div>
                    </div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, icon = 'ğŸµ') {
            // ç§»é™¤ç°æœ‰é€šçŸ¥
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <span class="notification-icon">${icon}</span>
                <span class="notification-message">${message}</span>
            `;

            document.body.appendChild(notification);

            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => notification.classList.add('show'), 100);

            // è‡ªåŠ¨éšè—
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const data = {
                playlists,
                playHistory,
                playStatistics,
                settings: {
                    theme: localStorage.getItem('theme'),
                    playMode: localStorage.getItem('playMode'),
                    volume: localStorage.getItem('volume'),
                    quality: localStorage.getItem('preferredQuality')
                },
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tunehub-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('æ•°æ®å¯¼å‡ºæˆåŠŸ', 'âœ…');
        }

        // å¯¼å…¥æ•°æ®
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    // å¯¼å…¥æ•°æ®
                    if (data.playlists) {
                        playlists = data.playlists;
                        savePlaylists();
                    }

                    if (data.playStatistics) {
                        playStatistics = data.playStatistics;
                    }

                    if (data.settings) {
                        Object.keys(data.settings).forEach(key => {
                            localStorage.setItem(key, data.settings[key]);
                        });
                    }

                    // æ›´æ–°æ˜¾ç¤º
                    updatePlaylistDisplay();
                    updateStatsDisplay();
                    updateRecommendations();

                    showNotification('æ•°æ®å¯¼å…¥æˆåŠŸ', 'âœ…');
                } catch (error) {
                    showNotification('å¯¼å…¥å¤±è´¥: æ–‡ä»¶æ ¼å¼é”™è¯¯', 'âŒ');
                }
            };

            reader.readAsText(file);

            // æ¸…ç©ºinput
            event.target.value = '';
        }

        // å¤‡ä»½æ•°æ®
        function backupData() {
            const data = localStorage.getItem('playlists') || '';
            const blob = new Blob([data], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tunehub-playlists-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('æ­Œå•å¤‡ä»½æˆåŠŸ', 'âœ…');
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰æ­Œå•ã€ç»Ÿè®¡å’Œè®¾ç½®ã€‚')) {
                localStorage.removeItem('playlists');
                localStorage.removeItem('playStatistics');
                playlists = {};
                playStatistics = {};

                updatePlaylistDisplay();
                updateStatsDisplay();
                updateRecommendations();

                showNotification('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º', 'âœ…');
            }
        }

        // åˆå§‹åŒ–åŠ è½½
        function initialize() {
            // åŠ è½½ä¸»é¢˜
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.body.classList.remove('light-mode');
                document.getElementById('themeIcon').textContent = 'â˜€ï¸';
            }

            // åŠ è½½æ’­æ”¾æ¨¡å¼
            const savedMode = localStorage.getItem('playMode');
            if (savedMode && PLAY_MODES[savedMode]) {
                currentPlayMode = savedMode;
                document.getElementById('playModeSelect').value = savedMode;
            }

            // åŠ è½½æ­Œå•å’Œç»Ÿè®¡
            loadPlaylists();
            const savedStats = localStorage.getItem('playStatistics');
            if (savedStats) {
                playStatistics = JSON.parse(savedStats);
            }

            // æ›´æ–°æ˜¾ç¤º
            updateStatsDisplay();
            updateRecommendations();

            // åˆå§‹åŒ–å¯è§†åŒ–
            if (window.AudioContext || window.webkitAudioContext) {
                initVisualizer();
            }
        }

        // æœç´¢éŸ³ä¹
        async function searchMusic() {
            const keyword = document.getElementById('searchInput').value.trim();
            const platform = document.getElementById('platformSelect').value;
            const quality = document.getElementById('qualitySelect').value;

            if (!keyword) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }

            currentQuality = quality;
            currentPlatform = platform;
            showLoading();

            try {
                let url;
                if (platform === 'aggregateSearch') {
                    url = `${API_BASE}/api/?type=aggregateSearch&keyword=${encodeURIComponent(keyword)}`;
                } else {
                    url = `${API_BASE}/api/?source=${platform}&type=search&keyword=${encodeURIComponent(keyword)}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.code === 200) {
                    displaySearchResults(data.data.results || data.data, platform);
                    localStorage.setItem('preferredQuality', quality);
                } else {
                    showError(data.message || 'æœç´¢å¤±è´¥');
                }
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(results, platform) {
            const songList = document.getElementById('songList');
            songs = results;

            songList.innerHTML = '<div class="song-list-title">æœç´¢ç»“æœ</div>';

            results.forEach((song, index) => {
                const songItem = document.createElement('div');
                songItem.className = 'song-item';

                // åˆ›å»ºæŒ‰é’®å®¹å™¨
                const buttonContainer = document.createElement('div');
                buttonContainer.style.position = 'absolute';
                buttonContainer.style.top = '5px';
                buttonContainer.style.right = '5px';
                buttonContainer.style.display = 'flex';
                buttonContainer.style.gap = '5px';

                // æ·»åŠ åˆ°æ­Œå•æŒ‰é’®
                const addToPlaylistBtn = document.createElement('button');
                addToPlaylistBtn.textContent = 'ğŸ“';
                addToPlaylistBtn.style.cssText = `
                    background: none;
                    border: none;
                    font-size: 16px;
                    cursor: pointer;
                    padding: 2px 4px;
                    border-radius: 4px;
                    transition: all 0.2s;
                `;
                addToPlaylistBtn.title = 'æ·»åŠ åˆ°æ­Œå•';
                addToPlaylistBtn.onmouseenter = function() {
                    this.style.background = 'rgba(102, 126, 234, 0.1)';
                };
                addToPlaylistBtn.onmouseleave = function() {
                    this.style.background = 'none';
                };
                addToPlaylistBtn.onclick = function(e) {
                    e.stopPropagation();
                    addSongToPlaylist(song);
                };

                buttonContainer.appendChild(addToPlaylistBtn);
                songItem.appendChild(buttonContainer);

                // æ’­æ”¾ç‚¹å‡»äº‹ä»¶
                songItem.onclick = () => playSong(index);

                // ä¸ºæ­Œæ›²æ·»åŠ å¹³å°å±æ€§ï¼Œç¡®ä¿æ’­æ”¾æ—¶èƒ½è·å–åˆ°æ­£ç¡®å¹³å°
                if (!song.platform) {
                    songs[index].platform = platform === 'aggregateSearch' ? song.platform : platform;
                }

                const platformInfo = platform === 'aggregateSearch' ? song.platform : platform;
                const coverUrl = `${API_BASE}/api/?source=${platformInfo}&id=${song.id}&type=pic`;

                songItem.innerHTML = `
                    <img src="${coverUrl}" alt="å°é¢" onerror="this.onerror=null;this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22 viewBox=%220 0 50 50%22><rect fill=%22%23ddd%22 width=%2250%22 height=%2250%22 rx=%2210%22/><text x=%2225%22 y=%2232%22 font-size=%2220%22 text-anchor=%22middle%22 fill=%22%23999%22>ğŸµ</text></svg>'">
                    <div class="song-info">
                        <div class="song-name">${song.name}</div>
                        <div class="song-artist">${song.artist || 'æœªçŸ¥æ­Œæ‰‹'}</div>
                    </div>
                `;

                songList.appendChild(songItem);
            });
        }

        // æ’­æ”¾æ­Œæ›²
        async function playSong(index) {
            // æ’­æ”¾æ¨¡å¼å¤„ç†
            if (currentPlayMode === 'shuffle') {
                index = Math.floor(Math.random() * songs.length);
            }

            // å•æ›²å¾ªç¯æ¨¡å¼
            if (currentPlayMode === 'single' && currentSongIndex !== undefined) {
                index = currentSongIndex;
            }

            currentSongIndex = index;
            const song = songs[index];
            currentSong = song;
            updateActiveSong(index);
            document.getElementById('currentSongName').textContent = song.name;
            document.getElementById('currentArtist').textContent = song.artist || 'æœªçŸ¥æ­Œæ‰‹';
            document.getElementById('currentAlbum').textContent = song.album || 'æœªçŸ¥ä¸“è¾‘';

            // æ›´æ–°æ’­æ”¾ç»Ÿè®¡
            updatePlayStatistics();

            // æ·»åŠ åˆ°æ’­æ”¾å†å²
            playHistory.unshift({
                song: song,
                playedAt: new Date().toISOString()
            });

            // é™åˆ¶å†å²è®°å½•æ•°é‡
            if (playHistory.length > 50) {
                playHistory = playHistory.slice(0, 50);
            }

            await loadSongInfo(song);
        }

        // åŠ è½½æ­Œæ›²ä¿¡æ¯
        async function loadSongInfo(song) {
            try {
                const platform = getSongPlatform(song);
                const infoUrl = `${API_BASE}/api/?source=${platform}&id=${song.id}&type=info`;
                const infoResponse = await fetch(infoUrl);
                const infoData = await infoResponse.json();

                if (infoData.code === 200) {
                    currentSongInfo = infoData.data;
                    displayCover(currentSongInfo.pic);
                    loadLyrics(currentSongInfo);
                    await preloadMultipleQualities(platform, song.id);
                    await loadAudio(getAudioUrl(currentQuality, platform, song.id));
                } else {
                    showError('è·å–æ­Œæ›²ä¿¡æ¯å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½æ­Œæ›²ä¿¡æ¯å¤±è´¥:', error);
                showError('åŠ è½½æ­Œæ›²ä¿¡æ¯å¤±è´¥');
            }
        }

        // æ˜¾ç¤ºå°é¢
        function displayCover(picUrl) {
            const albumCover = document.getElementById('albumCover');
            albumCover.innerHTML = `<img src="${picUrl}" alt="ä¸“è¾‘å°é¢" onerror="this.parentNode.innerHTML='<div class=\\'placeholder\\'>ğŸµ</div>'">`;
        }

        // åŠ è½½éŸ³é¢‘
        async function loadAudio(url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                const audioUrl = response.url;
                audio.src = audioUrl;
                audio.play();
            } catch (error) {
                console.error('åŠ è½½éŸ³é¢‘å¤±è´¥:', error);
                showError('åŠ è½½éŸ³é¢‘å¤±è´¥');
                await tryNextQuality();
            }
        }

        // åŠ è½½æ­Œè¯
        async function loadLyrics(songInfo) {
            try {
                if (songInfo.lrc) {
                    const response = await fetch(songInfo.lrc);
                    const lyricsText = await response.text();
                    lyricsData = parseLrc(lyricsText);
                    displayLyrics(lyricsData);
                } else {
                    document.getElementById('lyricsContent').innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">æš‚æ— æ­Œè¯</div>';
                    lyricsData = [];
                }
            } catch (error) {
                console.error('åŠ è½½æ­Œè¯å¤±è´¥:', error);
                document.getElementById('lyricsContent').innerHTML = '<div style="text-align: center; color: #f87171; padding: 40px;">åŠ è½½æ­Œè¯å¤±è´¥</div>';
            }
        }

        // è§£æLRCæ­Œè¯
        function parseLrc(text) {
            const lines = text.split('\n');
            const lyrics = [];

            lines.forEach(line => {
                // æ”¯æŒå¤šç§æ—¶é—´æ ¼å¼ï¼š[mm:ss.xx]ã€[mm:ss]ã€[mm:ss.xxx]ã€[mm:ss,xxx]
                const match = line.match(/\[(\d{2}):(\d{2})(?:[:.,]\d{2,3})?\](.*)/);
                if (match) {
                    const minutes = parseInt(match[1]);
                    const seconds = parseInt(match[2]);
                    let content = match[3].trim();

                    const timeMatch = line.match(/\[(\d{2}):(\d{2})[:.,](\d{2,3})\]/);
                    let ms = 0;
                    if (timeMatch) {
                        ms = parseInt(timeMatch[3]) / (timeMatch[3].length === 2 ? 100 : 1000);
                    }

                    if (!content) return;

                    lyrics.push({
                        time: minutes * 60 + seconds + ms,
                        content: content
                    });
                }
            });

            return lyrics;
        }

        // æ˜¾ç¤ºæ­Œè¯
        function displayLyrics(lyrics) {
            const lyricsContent = document.getElementById('lyricsContent');
            lyricsContent.innerHTML = '';

            lyrics.forEach((line, index) => {
                const lineElement = document.createElement('div');
                lineElement.className = 'lyrics-line';
                lineElement.textContent = line.content;
                lineElement.id = `lyrics-${index}`;
                lyricsContent.appendChild(lineElement);
            });
        }

        // æ›´æ–°æ­Œè¯é«˜äº®ï¼ˆå¸¦èŠ‚æµä¼˜åŒ–ï¼‰
        function updateLyricsHighlight() {
            if (!lyricsData.length) return;

            // èŠ‚æµï¼šé™åˆ¶æ›´æ–°é¢‘ç‡ï¼Œé¿å…é¢‘ç¹DOMæ“ä½œ
            if (lyricsUpdateTimer) {
                return;
            }

            lyricsUpdateTimer = setTimeout(() => {
                lyricsUpdateTimer = null;

                const currentTime = audio.currentTime;

                for (let i = 0; i < lyricsData.length; i++) {
                    const line = lyricsData[i];
                    const nextLine = lyricsData[i + 1];

                    if (currentTime >= line.time && (!nextLine || currentTime < nextLine.time)) {
                        // åªåœ¨æ­Œè¯è¡Œå˜åŒ–æ—¶æ‰æ›´æ–°
                        if (i !== lastLyricsIndex) {
                            lastLyricsIndex = i;

                            document.querySelectorAll('.lyrics-line').forEach(el => {
                                el.classList.remove('active');
                            });

                            const currentLine = document.getElementById(`lyrics-${i}`);
                            if (currentLine) {
                                currentLine.classList.add('active');

                                // ç›´æ¥è®¾ç½®æ­Œè¯å®¹å™¨ scrollTopï¼Œåªæ»šåŠ¨æ­Œè¯åŒºåŸŸ
                                const lyricsContent = document.getElementById('lyricsContent');
                                const containerHeight = lyricsContent.clientHeight;
                                const lineTop = currentLine.offsetTop;
                                const lineHeight = currentLine.offsetHeight;

                                lyricsContent.scrollTop = lineTop - (containerHeight / 2) + (lineHeight / 2);
                            }
                        }
                        break;
                    }
                }
            }, 50); // 50msèŠ‚æµ
        }

        // æ’­æ”¾/æš‚åœ
        function togglePlay() {
            if (currentSong) {
                if (isPlaying) {
                    audio.pause();
                } else {
                    audio.play();
                }
            }
        }

        // æ›´æ–°æ’­æ”¾æŒ‰é’®
        function updatePlayButton() {
            const playBtn = document.getElementById('playBtn');
            playBtn.textContent = isPlaying ? 'â¸' : 'â–¶';
        }

        // ä¸Šä¸€é¦–
        function previousSong() {
            if (songs.length > 0) {
                currentSongIndex = (currentSongIndex - 1 + songs.length) % songs.length;
                playSong(currentSongIndex);
            }
        }

        // ä¸‹ä¸€é¦–
        function nextSong() {
            if (songs.length === 0 || currentSongIndex === undefined) return;

            let nextIndex;
            if (currentPlayMode === 'loop') {
                nextIndex = (currentSongIndex + 1) % songs.length;
            } else {
                nextIndex = currentSongIndex + 1;
            }

            if (nextIndex < songs.length) {
                playSong(nextIndex);
            } else {
                // å¦‚æœæ˜¯åˆ—è¡¨å¾ªç¯æ¨¡å¼
                if (currentPlayMode === 'loop') {
                    playSong(0);
                } else {
                    // æ’­æ”¾ç»“æŸ
                    if (isPlaying) {
                        audio.pause();
                        isPlaying = false;
                        updatePlayButton();
                    }
                }
            }
        }

        // ä¸Šä¸€é¦–
        function previousSong() {
            if (songs.length === 0 || currentSongIndex === undefined) return;

            let prevIndex;
            if (currentPlayMode === 'loop' && currentSongIndex === 0) {
                prevIndex = songs.length - 1;
            } else {
                prevIndex = currentSongIndex - 1;
            }

            if (prevIndex >= 0) {
                playSong(prevIndex);
            }
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress() {
            const currentTime = audio.currentTime;
            const duration = audio.duration || 0;

            const percentage = (currentTime / duration) * 100;
            document.getElementById('progressFill').style.width = percentage + '%';

            document.getElementById('currentTime').textContent = formatTime(currentTime);
            updateLyricsHighlight();

            // æ›´æ–°è¿·ä½ æ’­æ”¾å™¨è¿›åº¦
            if (isMiniPlayer) {
                const miniProgressBar = document.querySelector('.mini-player-progress-bar');
                if (miniProgressBar) {
                    miniProgressBar.style.width = `${percentage}%`;
                }
            }
        }

        // è·³è½¬åˆ°æŒ‡å®šä½ç½®
        function seekTo(event) {
            const progressBar = event.currentTarget;
            const rect = progressBar.getBoundingClientRect();
            const percentage = (event.clientX - rect.left) / rect.width;

            if (audio.duration) {
                audio.currentTime = percentage * audio.duration;
            }
        }

        // é€šç”¨ä¸‹è½½å‡½æ•°ï¼ˆæå–é‡å¤ä»£ç ï¼‰
        async function downloadFile(url, fileName, type = 'blob') {
            try {
                const response = await fetch(url);
                let blob;

                if (type === 'text') {
                    const text = await response.text();
                    blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
                } else {
                    blob = await response.blob();
                }

                const objectUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = objectUrl;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(objectUrl);

                return true;
            } catch (error) {
                console.error(`ä¸‹è½½å¤±è´¥ (${fileName}):`, error);
                return false;
            }
        }

        // ä¸‹è½½å°é¢ï¼ˆä½¿ç”¨ fetchï¼Œä¸ä¼šæš‚åœéŸ³ä¹ï¼‰
        async function downloadCover() {
            if (!currentSongInfo || !currentSongInfo.pic) {
                showError('æ²¡æœ‰å¯ä¸‹è½½çš„å°é¢');
                return;
            }

            const safeSongName = sanitizeFileName(currentSong.name || 'cover');
            const safeArtistName = sanitizeFileName(currentSong.artist || '');
            const fileName = `${safeSongName}_${safeArtistName}.jpg`;

            const success = await downloadFile(currentSongInfo.pic, fileName);
            if (!success) {
                showError('å°é¢ä¸‹è½½å¤±è´¥');
            }
        }

        // ä¸‹è½½æ­Œè¯
        async function downloadLyrics() {
            if (!currentSong) {
                showError('è¯·å…ˆé€‰æ‹©æ­Œæ›²');
                return;
            }

            const safeSongName = sanitizeFileName(currentSong.name || 'lyrics');
            const safeArtistName = sanitizeFileName(currentSong.artist || '');
            const fileName = `${safeSongName}_${safeArtistName}.lrc`;

            if (lyricsData.length > 0) {
                // ä»å†…å­˜ä¸­çš„æ­Œè¯æ•°æ®ç”ŸæˆLRCå†…å®¹
                let lrcContent = '';
                lyricsData.forEach(line => {
                    const minutes = Math.floor(line.time / 60);
                    const seconds = (line.time % 60).toFixed(2);
                    const formattedSeconds = `${minutes}:${seconds.padStart(5, '0')}`;
                    lrcContent += `[${formattedSeconds}]\n${line.content}\n\n`;
                });

                const blob = new Blob([lrcContent], { type: 'text/plain;charset=utf-8' });
                const objectUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = objectUrl;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(objectUrl);
            } else if (currentSongInfo && currentSongInfo.lrc) {
                const success = await downloadFile(currentSongInfo.lrc, fileName, 'text');
                if (!success) {
                    showError('æ­Œè¯ä¸‹è½½å¤±è´¥');
                }
            }
        }

        // ä¸‹è½½å½“å‰éŸ³è´¨çš„éŸ³é¢‘
        async function downloadCurrentQualityAudio() {
            if (!currentSong || !audio.src) {
                showError('æ²¡æœ‰å¯ä¸‹è½½çš„éŸ³é¢‘');
                return;
            }

            const safeSongName = sanitizeFileName(currentSong.name || 'music');
            const safeArtistName = sanitizeFileName(currentSong.artist || '');
            const fileName = `${safeSongName}_${safeArtistName}.mp3`;

            const success = await downloadFile(audio.src, fileName);
            if (!success) {
                showError('éŸ³é¢‘ä¸‹è½½å¤±è´¥');
            }
        }

        // ä¸‹è½½æ­Œæ›²+æ­Œè¯
        async function downloadAudioAndLyrics() {
            if (!currentSong) {
                showError('è¯·å…ˆé€‰æ‹©æ­Œæ›²');
                return;
            }

            const safeSongName = sanitizeFileName(currentSong.name || 'music');
            const safeArtistName = sanitizeFileName(currentSong.artist || '');
            const audioFileName = `${safeSongName}_${safeArtistName}.mp3`;
            const lyricsFileName = `${safeSongName}_${safeArtistName}.lrc`;

            const downloadTasks = [];

            // ä¸‹è½½éŸ³é¢‘
            if (audio.src) {
                downloadTasks.push(downloadFile(audio.src, audioFileName));
            }

            // ä¸‹è½½æ­Œè¯
            if (lyricsData.length > 0) {
                // ä»å†…å­˜ä¸­çš„æ­Œè¯æ•°æ®ç”ŸæˆLRCå†…å®¹
                let lrcContent = '';
                lyricsData.forEach(line => {
                    const minutes = Math.floor(line.time / 60);
                    const seconds = (line.time % 60).toFixed(2);
                    const formattedSeconds = `${minutes}:${seconds.padStart(5, '0')}`;
                    lrcContent += `[${formattedSeconds}]\n${line.content}\n\n`;
                });

                const blob = new Blob([lrcContent], { type: 'text/plain;charset=utf-8' });
                const objectUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = objectUrl;
                a.download = lyricsFileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(objectUrl);
            } else if (currentSongInfo && currentSongInfo.lrc) {
                downloadTasks.push(downloadFile(currentSongInfo.lrc, lyricsFileName, 'text'));
            }

            try {
                await Promise.all(downloadTasks);
            } catch (error) {
                console.error('ä¸‹è½½å¤±è´¥:', error);
            }
        }

        // ä¸‹è½½å…¨éƒ¨ï¼ˆéŸ³é¢‘+æ­Œè¯+å°é¢ï¼‰
        async function downloadAll() {
            if (!currentSong) {
                showError('è¯·å…ˆé€‰æ‹©æ­Œæ›²');
                return;
            }

            const safeSongName = sanitizeFileName(currentSong.name || 'music');
            const safeArtistName = sanitizeFileName(currentSong.artist || '');
            const audioFileName = `${safeSongName}_${safeArtistName}.mp3`;
            const lyricsFileName = `${safeSongName}_${safeArtistName}.lrc`;
            const coverFileName = `${safeSongName}_${safeArtistName}.jpg`;

            const downloadTasks = [];

            // ä¸‹è½½éŸ³é¢‘
            if (audio.src) {
                downloadTasks.push(downloadFile(audio.src, audioFileName));
            }

            // ä¸‹è½½æ­Œè¯
            if (lyricsData.length > 0) {
                // ä»å†…å­˜ä¸­çš„æ­Œè¯æ•°æ®ç”ŸæˆLRCå†…å®¹
                let lrcContent = '';
                lyricsData.forEach(line => {
                    const minutes = Math.floor(line.time / 60);
                    const seconds = (line.time % 60).toFixed(2);
                    const formattedSeconds = `${minutes}:${seconds.padStart(5, '0')}`;
                    lrcContent += `[${formattedSeconds}]\n${line.content}\n\n`;
                });

                const blob = new Blob([lrcContent], { type: 'text/plain;charset=utf-8' });
                const objectUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = objectUrl;
                a.download = lyricsFileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(objectUrl);
            } else if (currentSongInfo && currentSongInfo.lrc) {
                downloadTasks.push(downloadFile(currentSongInfo.lrc, lyricsFileName, 'text'));
            }

            // ä¸‹è½½å°é¢
            if (currentSongInfo && currentSongInfo.pic) {
                downloadTasks.push(downloadFile(currentSongInfo.pic, coverFileName));
            }

            try {
                await Promise.all(downloadTasks);
            } catch (error) {
                console.error('ä¸‹è½½å¤±è´¥:', error);
            }
        }

        // è·å–æ­Œæ›²å¹³å°
        function getSongPlatform(song) {
            if (song.platform) return song.platform;
            if (song.url && song.url.includes('netease')) return 'netease';
            if (song.url && song.url.includes('kuwo')) return 'kuwo';
            if (song.url && song.url.includes('qq')) return 'qq';
            return 'netease';
        }

        // é¢„åŠ è½½å¤šä¸ªéŸ³è´¨çš„URLï¼ˆå¹¶è¡Œä¼˜åŒ–ï¼‰
        async function preloadMultipleQualities(platform, songId) {
            audioUrlMap = {};

            // ä½¿ç”¨Promise.allå¹¶è¡Œé¢„åŠ è½½æ‰€æœ‰éŸ³è´¨
            const preloadPromises = QUALITIES.map(async (quality) => {
                try {
                    const url = `${API_BASE}/api/?source=${platform}&id=${songId}&type=url&br=${quality}`;
                    const response = await fetch(url, { method: 'HEAD' });
                    audioUrlMap[quality] = response.url;
                    return { quality, success: true };
                } catch (error) {
                    console.log(`æ— æ³•è·å–éŸ³è´¨ ${quality}:`, error);
                    return { quality, success: false, error };
                }
            });

            // ç­‰å¾…æ‰€æœ‰é¢„åŠ è½½å®Œæˆ
            await Promise.allSettled(preloadPromises);
        }

        // è·å–éŸ³é¢‘URLï¼Œå¦‚æœæ²¡æœ‰é¢„åŠ è½½åˆ™è¿”å›åŸå§‹URL
        function getAudioUrl(quality, platform, songId) {
            if (audioUrlMap[quality]) {
                return audioUrlMap[quality];
            }
            // å¦‚æœé¢„åŠ è½½å¤±è´¥ï¼Œè¿”å›åŸå§‹URL
            return `${API_BASE}/api/?source=${platform}&id=${songId}&type=url&br=${quality}`;
        }

        // æ›´æ–°æ´»è·ƒæ­Œæ›²
        function updateActiveSong(index) {
            document.querySelectorAll('.song-item').forEach((item, i) => {
                if (i === index) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            const songList = document.getElementById('songList');
            songList.innerHTML = '<div class="loading">æœç´¢ä¸­...</div>';
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const songList = document.getElementById('songList');
            songList.innerHTML = `<div class="error">${message}</div>`;
        }

        // åˆ‡æ¢éŸ³è´¨ï¼ˆå®æ—¶åˆ‡æ¢ï¼Œä¿æŒæ’­æ”¾è¿›åº¦ï¼‰
        async function changeQuality() {
            const newQuality = document.getElementById('qualityChange').value;

            if (newQuality === currentQuality || !currentSongInfo) return;

            // ä¿å­˜å½“å‰æ’­æ”¾è¿›åº¦
            const currentTime = audio.currentTime;
            const wasPlaying = !audio.paused;

            currentQuality = newQuality;
            document.getElementById('currentQuality').textContent = `å½“å‰éŸ³è´¨: ${QUALITY_NAMES[newQuality]}`;
            localStorage.setItem('preferredQuality', newQuality);

            const platform = getSongPlatform(currentSong);
            if (audio.src) {
                // æ˜¾ç¤ºçŠ¶æ€æŒ‡ç¤ºå™¨
                const qualityStatus = document.getElementById('qualityStatus');
                const playBtn = document.getElementById('playBtn');
                const originalText = playBtn.textContent;

                qualityStatus.style.display = 'inline';
                playBtn.textContent = 'â³';
                playBtn.disabled = true;

                try {
                    // è·å–æ–°éŸ³è´¨çš„URL
                    const newUrl = getAudioUrl(newQuality, platform, currentSong.id);
                    const response = await fetch(newUrl, { method: 'HEAD' });
                    const audioUrl = response.url;

                    // è®¾ç½®æ–°éŸ³é¢‘æºï¼Œä¿æŒæ’­æ”¾è¿›åº¦
                    audio.src = audioUrl;
                    audio.currentTime = currentTime;

                    // å¦‚æœä¹‹å‰åœ¨æ’­æ”¾ï¼Œç»§ç»­æ’­æ”¾
                    if (wasPlaying) {
                        await audio.play();
                    }

                    // éšè—çŠ¶æ€æŒ‡ç¤ºå™¨
                    qualityStatus.style.display = 'none';
                    playBtn.textContent = originalText;
                    playBtn.disabled = false;
                } catch (error) {
                    console.error('åˆ‡æ¢éŸ³è´¨å¤±è´¥:', error);
                    showError('åˆ‡æ¢éŸ³è´¨å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€éŸ³è´¨');

                    // éšè—çŠ¶æ€æŒ‡ç¤ºå™¨
                    qualityStatus.style.display = 'none';
                    playBtn.textContent = originalText;
                    playBtn.disabled = false;

                    // å°è¯•ä¸‹ä¸€ä¸ªå¯ç”¨éŸ³è´¨
                    await tryNextQuality();
                }
            }
        }

        // è·å–éŸ³è´¨åç§°
        function getQualityName(quality) {
            return QUALITY_NAMES[quality] || quality;
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        // æ¸…ç†æ–‡ä»¶å
        function sanitizeFileName(fileName) {
            return fileName
                .replace(/[<>:"/\\|?*]/g, '')
                .replace(/\s+/g, '_')
                .substring(0, 100);
        }

        // åˆå§‹åŒ–éŸ³è´¨é€‰æ‹©
        function initQuality() {
            const savedQuality = localStorage.getItem('preferredQuality');
            if (savedQuality && QUALITIES.includes(savedQuality)) {
                currentQuality = savedQuality;
                document.getElementById('qualitySelect').value = savedQuality;
                document.getElementById('qualityChange').value = savedQuality;
                document.getElementById('currentQuality').textContent = `å½“å‰éŸ³è´¨: ${QUALITY_NAMES[savedQuality]}`;
            }
        }

        // å°è¯•ä¸‹ä¸€ä¸ªå¯ç”¨éŸ³è´¨
        async function tryNextQuality() {
            const currentIndex = QUALITIES.indexOf(currentQuality);
            const platform = getSongPlatform(currentSong);

            for (let i = currentIndex + 1; i < QUALITIES.length; i++) {
                const nextQuality = QUALITIES[i];
                const nextUrl = getAudioUrl(nextQuality, platform, currentSong.id);

                // å°è¯•åŠ è½½è¿™ä¸ªéŸ³è´¨
                try {
                    const response = await fetch(nextUrl, { method: 'HEAD' });
                    if (response.url) {
                        currentQuality = nextQuality;
                        document.getElementById('currentQuality').textContent = `å½“å‰éŸ³è´¨: ${QUALITY_NAMES[nextQuality]}`;
                        document.getElementById('qualityChange').value = nextQuality;
                        await loadAudio(response.url);
                        return;
                    }
                } catch (error) {
                    console.log(`å°è¯•éŸ³è´¨ ${nextQuality} å¤±è´¥:`, error);
                }
            }

            // æ‰€æœ‰éŸ³è´¨éƒ½å¤±è´¥ï¼Œå°è¯•åˆ‡æ¢åˆ°QQéŸ³ä¹
            const currentPlatform = getSongPlatform(currentSong);
            if (currentPlatform === 'kuwo') {
                console.log('é…·æˆ‘éŸ³ä¹æ‰€æœ‰éŸ³è´¨åŠ è½½å¤±è´¥ï¼Œå°è¯•åˆ‡æ¢åˆ°QQéŸ³ä¹...');
                const songId = currentSong.id;
                const songName = currentSong.name;
                const songArtist = currentSong.artist;

                // æœç´¢QQéŸ³ä¹ä¸­çš„ç›¸åŒæ­Œæ›²
                const qqSearchUrl = `${API_BASE}/api/?source=qq&type=search&keyword=${encodeURIComponent(`${songName} ${songArtist}`)}`;
                try {
                    const response = await fetch(qqSearchUrl);
                    const data = await response.json();

                    if (data.code === 200 && data.data && data.data.length > 0) {
                        // æ‰¾åˆ°åŒ¹é…çš„æ­Œæ›²ï¼Œæ›¿æ¢å½“å‰æ­Œæ›²
                        const qqSong = data.data[0];
                        currentSong = {
                            ...qqSong,
                            platform: 'qq',
                            originalPlatform: 'kuwo',
                            originalSongId: songId,
                            originalSongName: songName
                        };

                        // æ›´æ–°UI
                        document.getElementById('currentSongName').textContent = qqSong.name;
                        document.getElementById('currentArtist').textContent = qqSong.artist || 'æœªçŸ¥æ­Œæ‰‹';
                        document.getElementById('currentAlbum').textContent = qqSong.album || 'æœªçŸ¥ä¸“è¾‘';

                        // é‡æ–°åŠ è½½æ­Œæ›²ä¿¡æ¯
                        await loadSongInfo(currentSong);
                        return;
                    }
                } catch (error) {
                    console.log('åˆ‡æ¢QQéŸ³ä¹å¤±è´¥:', error);
                }
            }

            showError('æ— æ³•åŠ è½½ä»»ä½•éŸ³è´¨çš„éŸ³é¢‘');
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(event) {
            if (event.code === 'Space') {
                event.preventDefault();
                togglePlay();
            } else if (event.code === 'ArrowLeft') {
                event.preventDefault();
                audio.currentTime -= 10;
            } else if (event.code === 'ArrowRight') {
                event.preventDefault();
                audio.currentTime += 10;
            }
        });

        // æœç´¢æ¡†å›è½¦äº‹ä»¶
        document.getElementById('searchInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                searchMusic();
            }
        });
    </script>
</body>
</html>
